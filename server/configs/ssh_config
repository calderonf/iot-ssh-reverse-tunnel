# Configuración SSH del Servidor para Túneles SSH Inversos IoT
# Ubicación: /etc/ssh/sshd_config.d/iot-tunnel.conf

# Puerto SSH (cambiar si se requiere puerto no estándar)
Port 22

# Direcciones de escucha
ListenAddress 0.0.0.0
ListenAddress ::

# Autenticación
PubkeyAuthentication yes
PasswordAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no

# Usuario dedicado para túneles IoT
Match User iot-tunnel
    AllowTcpForwarding remote
    GatewayPorts clientspecified       # Permite 0.0.0.0 o IP concreta si el cliente lo pide
    X11Forwarding no
    AllowAgentForwarding no
    PermitTTY no

    # Enumerar puertos permitidos para -R:
    PermitListen 10000
    PermitListen 10001
    PermitListen 10002

    ClientAliveInterval 30
    ClientAliveCountMax 3
    MaxSessions 100

    # ForceCommand /usr/local/bin/tunnel-only.sh

    # ForceCommand /usr/local/bin/tunnel-only.sh

    # Limitar túneles al rango de puertos 10000-20000 (patrones soportados por sshd)
    PermitOpen localhost:1???? localhost:20000

    # Keep-alive para mantener conexiones activas
    ClientAliveInterval 30
    ClientAliveCountMax 3

    # Límites de sesiones concurrentes
    MaxSessions 100
    MaxStartups 100:30:200

# Configuración de logging
SyslogFacility AUTH
LogLevel VERBOSE

# Configuración de seguridad adicional
StrictModes yes
PermitRootLogin no
MaxAuthTries 3

# Keep-alive global
TCPKeepAlive yes

# Timeouts
LoginGraceTime 2m

# Configuración de claves
PubkeyAcceptedKeyTypes ssh-ed25519,ecdsa-sha2-nistp256,ecdsa-sha2-nistp384,ecdsa-sha2-nistp521,ssh-rsa

# Banner (opcional)
# Banner /etc/ssh/banner.txt
